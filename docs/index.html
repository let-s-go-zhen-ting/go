<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Let's Go！！！｜首頁</title>
  <link rel="stylesheet" href="assets/ui.css?v=4">
</head>
<body>
  <!-- 頂部：左上頭貼 → 開啟側拉；右側是購物車 -->
  <header class="header-bar">
  <button id="avatarBtn" class="avatar" aria-label="開啟個人選單">我</button>

  <input id="search" class="search flex1" placeholder="搜尋商品名稱…（例如 手幅）">

  <!-- 下拉 1：分類 -->
  <select id="category" class="select">
    <option value="ALL">全部分類</option>
    <option value="周邊">周邊</option>
    <option value="演出">演出</option>
  </select>

  <!-- 下拉 2：排序 -->
  <select id="sort" class="select">
    <option value="default">預設排序</option>
    <option value="price_asc">價格低→高</option>
    <option value="price_desc">價格高→低</option>
  </select>

  <!-- 下拉 3：篩選 -->
  <select id="filter" class="select">
    <option value="all">全部商品</option>
    <option value="new">只看新上</option>
    <option value="instock">只看有庫存</option>
  </select>

  <div class="cart-group">
    <a href="checkout.html" class="btn secondary">購物車/結帳</a>
    <span class="badge" id="cartCount">0</span>
  </div>
</header>


  <!-- 最近瀏覽 -->
  <section class="card">
    <h2>你最近看過</h2>
    <div id="recentGrid" class="grid"></div>
    <div class="small">（點「看一下」會記錄到這裡）</div>
  </section>

  <!-- 新上 -->
  <section class="card">
    <h2>新上</h2>
    <div id="newGrid" class="grid"></div>
  </section>

  <!-- 全部商品（支援搜尋與分類） -->
  <section class="card">
    <h2>全部商品</h2>
    <div id="allGrid" class="grid"></div>
  </section>

  <!-- 側拉抽屜 -->
  <div id="drawerMask"></div>
<aside id="drawer" aria-label="個人側拉面板">
  <div id="drawerProfile"><!-- JS 會把內容塞進來 --></div>
</aside>


  <script type="module">
  import { setCart, getCart, renderCards, getRecent, filterProducts, setupDrawer, initProducts, PRODUCTS } from './assets/app.js?v=3';

  // 先抓試算表，再渲染
  await initProducts('1BDw71gFOYp0e2kqOZFkfbV5v1dgC99kgwUEaHwjvxTk','商品');

    // 初始化購物車徽章
    setCart(getCart());

    // 新上
    const newGrid = document.getElementById('newGrid');
    const newList = PRODUCTS.filter(p=>p.isNew);
    renderCards(newGrid, newList);

    // 最近瀏覽
    const recentGrid = document.getElementById('recentGrid');
    const recentList = getRecent();
    if(recentList.length){
      renderCards(recentGrid, recentList);
    }else{
      recentGrid.innerHTML = '<div class="small">還沒有足跡喔～</div>';
    }

    // 全部商品 + 搜尋/分類
    const allGrid = document.getElementById('allGrid');
  const search  = document.getElementById('search');
  const category= document.getElementById('category');

  function rerender(){
    let list = filterProducts({ q: search.value, cat: category.value });

    const f = document.getElementById('filter').value;
    if (f === 'new')     list = list.filter(p => p.isNew);
    if (f === 'instock') list = list.filter(p => (p.stock ?? 0) > 0);

    const s = document.getElementById('sort').value;
    if (s === 'price_asc')  list = list.slice().sort((a,b)=> a.price - b.price);
    if (s === 'price_desc') list = list.slice().sort((a,b)=> b.price - a.price);

    renderCards(allGrid, list);
  }

  search.addEventListener('input', rerender);
  category.addEventListener('change', rerender);
  document.getElementById('sort').addEventListener('change', rerender);
  document.getElementById('filter').addEventListener('change', rerender);

  rerender();  // 👈 這行一定要有，首次渲染
  setupDrawer();


    // 啟動側拉面板
    setupDrawer();
  </script>
</body>
</html>
