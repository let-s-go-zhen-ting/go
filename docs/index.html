<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Let's Go！！！｜首頁</title>
  <link rel="stylesheet" href="assets/ui.css?v=4">
</head>
<body>
  <!-- 頂部：左上頭貼 → 開啟側拉；右側是購物車 -->
  <header class="header-bar">
  <button id="avatarBtn" class="avatar" aria-label="開啟個人選單">我</button>

  <input id="search" class="search flex1" placeholder="搜尋商品名稱…（例如 手幅）">

  <!-- 下拉 1：分類 -->
  <select id="origin" class="select">
    <option value="ALL">韓團/中國</option>
    <option value="韓團">韓團</option>
    <option value="中國">中國</option>
  </select>

  <!-- 下拉 2：排序 -->
  <select id="category" class="select">
    <option value="default">全部類型</option>
    <option value="演唱會">演唱會</option>
    <option value="回憶錄">回憶錄</option>
  </select>

  <!-- 下拉 3：篩選 -->
  <select id="filter" class="select">
    <option value="all">全部商品</option>
    <option value="new">只看新上</option>
    <option value="instock">只看有庫存</option>
  </select>

  <div class="cart-group">
    <a href="checkout.html" class="btn secondary">購物車/結帳</a>
    <span class="badge" id="cartCount">0</span>
  </div>
</header>


  <!-- 最近瀏覽 -->
  <section class="card">
    <h2>你最近看過</h2>
    <div id="recentGrid" class="grid list"></div>
    <div class="small">（點「看一下」會記錄到這裡）</div>
  </section>

  <!-- 新上 -->
  <section class="card">
    <h2>新上</h2>
    <div id="newGrid" class="grid list"></div>
  </section>

  <!-- 全部商品（支援搜尋與分類） -->
  <section class="card">
    <h2>全部商品</h2>
    <div id="allGrid" class="grid list"></div>
  </section>

  <!-- 側拉抽屜 -->
  <div id="drawerMask"></div>
<aside id="drawer" aria-label="個人側拉面板">
  <div id="drawerProfile"><!-- JS 會把內容塞進來 --></div>
</aside>


  <script type="module">
  import { setCart, getCart, renderCards, getRecent, filterProducts, setupDrawer, initProducts, PRODUCTS } from './assets/app.js?v=3';

  // 先抓試算表，再渲染
  await initProducts('1BDw71gFOYp0e2kqOZFkfbV5v1dgC99kgwUEaHwjvxTk','商品');

    // 初始化購物車徽章
    setCart(getCart());

    const recentGrid = document.getElementById('recentGrid');
const newGrid    = document.getElementById('newGrid');
const allGrid    = document.getElementById('allGrid');

const search     = document.getElementById('search');
const category   = document.getElementById('category');
const groupSel   = document.getElementById('group');   // 可能不存在
const sortSel    = document.getElementById('sort');    // 可能不存在
const filterSel  = document.getElementById('filter');  // 可能不存在

function filterByUI(list){
  const cat = category?.value || 'ALL';
  const grp = groupSel?.value || 'ALL';
  const f   = filterSel?.value || 'all';

  let out = list.filter(p =>
    (cat==='ALL' || p.category===cat) &&
    (grp==='ALL' || p.group===grp)
  );
  if (f === 'new')     out = out.filter(p => p.isNew);
  if (f === 'instock') out = out.filter(p => (p.stock ?? 0) > 0);
  return out;
}

function rerender(){
  let all = filterProducts({
    q:  search?.value || '',
    cat: category?.value || 'ALL',
    group: groupSel?.value || 'ALL',
  });
  all = filterByUI(all);
  if (sortSel?.value === 'price_asc')  all = all.slice().sort((a,b)=>a.price-b.price);
  if (sortSel?.value === 'price_desc') all = all.slice().sort((a,b)=>b.price-a.price);
  renderCards(allGrid, all);

  const recent = filterByUI(getRecent());
  recentGrid.innerHTML = recent.length ? '' : '<div class="small">還沒有足跡喔～</div>';
  if (recent.length) renderCards(recentGrid, recent);

  const newest = filterByUI(PRODUCTS.filter(p=>p.isNew));
  renderCards(newGrid, newest);
}

search?.addEventListener('input', rerender);
category?.addEventListener('change', rerender);
groupSel?.addEventListener('change', rerender);
sortSel?.addEventListener('change', rerender);
filterSel?.addEventListener('change', rerender);

rerender();
setupDrawer();



    // 啟動側拉面板
    setupDrawer();
  </script>
</body>
</html>
