<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>後台審單</title>
  <link rel="stylesheet" href="assets/ui.css">
  <!-- Favicon / PWA icons -->
  <link rel="icon" type="image/png" href="favicon.png?v=2">
  <link rel="apple-touch-icon" href="apple-touch-icon.png?v=2">

</head>
<body>
  <header>
    <h1>後台審單</h1>
    <div><button class="btn secondary" id="signOutBtn">登出</button></div>
  </header>

  <!-- 登入卡片：管理員用 Email/密碼登入 -->
  <section class="card" id="loginCard">
    <h2>管理員登入</h2>
    <label>Email</label>
    <input class="input" id="email" placeholder="YOUR_ADMIN_EMAIL@example.com" type="email">
    <label>密碼</label>
    <input class="input" id="password" type="password" placeholder="••••••••">
    <div style="margin-top:12px"><button class="btn" id="loginBtn">登入</button></div>
    <div class="small">請先在 Firebase Authentication 建立此帳號。</div>
  </section>

  <!-- 訂單列表卡片（登入後顯示） -->
  <section class="card" id="ordersCard" style="display:none">
    <h2>待審核（有上傳憑證）</h2>
    <div id="orders"></div>
  </section>

  <script type="module">
  import { auth, db, isAdminUser } from "./assets/firebase.js?v=6";
  import { onAuthStateChanged, signInWithEmailAndPassword, signOut } 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { collection, query, where, orderBy, getDocs, doc, updateDoc, serverTimestamp }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const $ = id => document.getElementById(id);
  const loginCard  = $('loginCard');
  const ordersCard = $('ordersCard');
  const ordersDiv  = $('orders');

  // 登入按鈕：先登入，再檢查是否管理員；不是就立刻登出並提示
  $('loginBtn')?.addEventListener('click', async ()=>{
    const email = $('email').value.trim();
    const pw    = $('password').value.trim();
    if(!email || pw.length < 6){ alert('請填 Email 與至少 6 碼密碼'); return; }
    try{
      await signInWithEmailAndPassword(auth, email, pw);
      if(!isAdminUser(auth.currentUser)){
        await signOut(auth);
        alert('非管理員帳號，已拒絕存取');
        location.href = 'index.html';
      }
      // 是管理員的話，onAuthStateChanged 會自動進入 load()
    }catch(e){
      alert('登入失敗：' + (e?.message || e));
    }
  });

  // 登出
  $('signOutBtn')?.addEventListener('click', async ()=>{ await signOut(auth); });

  // 監聽登入狀態：只有管理員才顯示訂單清單；否則顯示登入或導回
  onAuthStateChanged(auth, async (u)=>{
    if (!u) {
      loginCard.style.display = 'block';
      ordersCard.style.display = 'none';
      return;
    }
    if (!isAdminUser(u)) {
      // 已登入但不是管理員 → 立即導回或顯示無權限
      loginCard.style.display = 'block';
      ordersCard.style.display = 'none';
      alert('無權限存取此頁');
      location.href = 'index.html';
      return;
    }
    // 是管理員 → 顯示清單
    loginCard.style.display = 'none';
    ordersCard.style.display = 'block';
    await load(); // 你的載入訂單函式（維持原本）
  });

  async function load(){
    const q = query(collection(db, "orders"), orderBy("createdAt","desc"));
    const snaps = await getDocs(q);
    ordersDiv.innerHTML = "";
    snaps.forEach(s=>{
      const o = s.data();
      const created = o.createdAt?.toDate ? o.createdAt.toDate().toLocaleString('zh-TW'): '';
      const html = `
        <div class="card">
          <div><strong>訂單 ${s.id}</strong>｜NT$ ${o.amount}｜${created}</div>
          <div>付款：${o.paymentMethod}｜付款狀態：<b>${o.paymentStatus||'-'}</b>｜物流：<b>${o.shipmentStatus||'-'}</b></div>
          <div>配送：${o.deliveryMethod||'-'}</div>
          <div>收件人：${o?.receiver?.name||''}｜${o?.receiver?.phone||''}</div>
          <div style="margin-top:10px" class="row">
            <button class="btn" data-action="markPaid" data-id="${s.id}">標記已付款</button>
            <button class="btn secondary" data-action="toShip" data-id="${s.id}">設為「待發貨」</button>
            <button class="btn secondary" data-action="inbound" data-id="${s.id}">設為「待運回」</button>
            <button class="btn secondary" data-action="toSend" data-id="${s.id}">設為「待寄出」</button>
            <button class="btn secondary" data-action="pickupReady" data-id="${s.id}">到店可取</button>
            <button class="btn secondary" data-action="meetup" data-id="${s.id}">面交中</button>
          </div>
        </div>`;
      const el = document.createElement('div');
      el.innerHTML = html;
      ordersDiv.appendChild(el.firstElementChild);
    });
  }

  // 按鈕事件（一次掛在容器上）
  ordersDiv.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-action]');
    if(!btn) return;
    const id = btn.dataset.id;
    const ref = doc(db, "orders", id);

    try{
      switch(btn.dataset.action){
        case 'markPaid':
          await updateDoc(ref, { paymentStatus: 'paid', paidAt: serverTimestamp(), shipmentStatus: 'none' });
          break;
        case 'toShip':        // 已付款，尚未安排出貨
          await updateDoc(ref, { paymentStatus: 'paid', shipmentStatus: 'none' });
          break;
        case 'inbound':       // 海外/外部運回中
          await updateDoc(ref, { shipmentStatus: 'inbound' });
          break;
        case 'toSend':        // 我方收到貨，準備寄出
          await updateDoc(ref, { shipmentStatus: 'to_send' });
          break;
        case 'pickupReady':   // 超商到店可取
          await updateDoc(ref, { deliveryMethod: 'seven', shipmentStatus: 'pickup_ready' }); // 或 'arrived'
          break;
        case 'meetup':        // 面交流程中
          await updateDoc(ref, { deliveryMethod: 'meetup', shipmentStatus: 'to_send' });
          break;
      }
      alert('已更新狀態');
      await load();
    }catch(err){
      alert('更新失敗：' + (err?.message || err));
    }
  });

</script>
