<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>結帳</title>
  <link rel="stylesheet" href="assets/ui.css">
</head>
<body>
  <header>
    <h1>結帳</h1>
    <div><a class="btn secondary" href="index.html">← 回商店</a></div>
  </header>

  <!-- 顯示購物車品項與總額 -->
  <section class="card">
    <h2>購物車</h2>
    <table id="cartTable"><thead><tr><th>品名</th><th>數量</th><th>小計</th></tr></thead><tbody></tbody></table>
    <div style="text-align:right">總額：<strong id="total">NT$ 0</strong></div>
  </section>

  <!-- 收件與付款資訊 -->
  <section class="card">
  <h2>收件與付款</h2>
  <div class="row">
    <div style="flex:1">
      <label>收件人姓名</label>
      <input class="input" id="name" placeholder="王小明">
    </div>
    <div style="flex:1">
      <label>電話</label>
      <input class="input" id="phone" placeholder="0912345678" inputmode="numeric" pattern="[0-9]*" maxlength="10">
    </div>
  </div>

  <!-- 取貨方式 -->
  <label>取貨方式</label>
  <div class="row">
    <label><input type="radio" name="ship" value="seven" checked> 7-ELEVEN 交貨便</label>
    <label><input type="radio" name="ship" value="meetup"> 面交（沙鹿/大甲/豐原/后里）</label>
  </div>

  <!-- 7-11：門市資訊 -->
  <div id="sevenBox">
    <label>7-ELEVEN 門市名稱</label>
    <input class="input" id="sevenStoreName" placeholder="例如：台中中清門市">
    <label>門市代碼（知道再填）</label>
    <input class="input" id="sevenStoreId" placeholder="可留白">
  </div>

  <!-- 面交：地點下拉與備註時間 -->
  <div id="meetupBox" style="display:none">
    <label>面交地點</label>
    <select class="input" id="meetupPlace">
      <option value="">請選擇</option>
      <option>沙鹿</option>
      <option>大甲</option>
      <option>豐原</option>
      <option>后里</option>
    </select>
    <label>面交時間（可留白，之後 LINE 喬）</label>
    <input class="input" id="meetupTime" placeholder="例如：週六 下午 3 點">
  </div>

  <label>付款方式</label>
  <div class="row">
    <label><input type="radio" name="pm" value="bank_transfer" checked> 匯款</label>
    <label><input type="radio" name="pm" value="cardless"> 無卡存款</label>
    <label><input type="radio" name="pm" value="cod"> 貨到付款</label>
  </div>

  <div class="small">匯款/無卡：下單後到 LINE 回報；面交在現場付款也可（可在備註說明）。</div>
  <div style="margin-top:12px"><button class="btn" id="placeOrderBtn">送出訂單</button></div>
</section>


  <!-- 匯款資訊（前端硬編，或改成從 Firestore 讀取） -->
  <section class="card">
    <h2>匯款資訊（可於訂單頁再看到）</h2>
    <div class="small">銀行代碼/帳號/戶名請自行改在前端或改成從 Firestore 讀取。</div>
    <div>銀行代碼：<strong>700</strong></div>
    <div>帳號：<strong>0123456789</strong></div>
    <div>戶名：<strong>L&欸嘍</strong></div>
  </section>

 <script type="module">
  // 這頁只需要 Firestore（送單）與匿名登入
  import { app, db, auth, ensureSignedInAnon } from "./assets/firebase.js?v=6";
  import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // 讀 localStorage 的購物車
  function getCart(){ return JSON.parse(localStorage.getItem('cart')||'[]'); }

  // 把購物車渲染到表格
  function renderCart(){
    const cart = getCart();
    const body = document.querySelector('#cartTable tbody');
    if (!cart.length) {
      body.innerHTML = `<tr><td colspan="3">購物車是空的，回<a href="index.html">首頁</a>挑選商品吧！</td></tr>`;
      document.getElementById('total').textContent = 'NT$ 0';
      return { cart, total: 0 };
    }
    body.innerHTML = cart.map(i=>`<tr>
      <td>${i.title}</td>
      <td>${i.qty}</td>
      <td>NT$ ${i.price*i.qty}</td>
    </tr>`).join("");
    const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
    document.getElementById('total').textContent = 'NT$ '+total;
    return { cart, total };
  }
  let { cart, total } = renderCart();

  // 電話只允許 10 碼數字
  document.getElementById('phone').addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 10);
  });

  // === 新增：切換顯示區塊（7-11 / 面交） ===
  const sevenBox = document.getElementById('sevenBox');
  const meetupBox = document.getElementById('meetupBox');
  document.querySelectorAll('input[name="ship"]').forEach(r=>{
    r.addEventListener('change', ()=>{
      const val = document.querySelector('input[name="ship"]:checked').value;
      sevenBox.style.display = (val==='seven') ? 'block' : 'none';
      meetupBox.style.display = (val==='meetup') ? 'block' : 'none';
    });
  });

  // === 新版送出訂單（取代你原本的 address 版本） ===
  document.getElementById('placeOrderBtn').addEventListener('click', async () => {
    let cart = getCart(); // 再抓一次最新的
    if(cart.length===0){ alert('購物車是空的'); return; }

    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    if(!name){ alert('請輸入收件人姓名'); return; }
    if(!/^\d{10}$/.test(phone)){ alert('電話請輸入 10 碼數字（例如 0912345678）'); return; }

    const ship = document.querySelector('input[name="ship"]:checked').value;

    // 收件資訊：依取貨方式組資料
    let deliveryMethod, deliveryDetails;
    if (ship === 'seven') {
      const storeName = document.getElementById('sevenStoreName').value.trim();
      const storeId = document.getElementById('sevenStoreId').value.trim();
      if(!storeName){ alert('請填 7-ELEVEN 門市名稱'); return; }
      deliveryMethod = 'seven';
      deliveryDetails = { storeName, storeId };
    } else {
      const place = document.getElementById('meetupPlace').value;
      const time = document.getElementById('meetupTime').value.trim();
      if(!place){ alert('請選擇面交地點'); return; }
      deliveryMethod = 'meetup';
      deliveryDetails = { place, time };
    }

    const pm = document.querySelector('input[name="pm"]:checked').value;

    await ensureSignedInAnon();
    const uid = auth.currentUser.uid;

    const order = {
      uid,
      items: cart.map(i=>({ productId:i.id, title:i.title, qty:i.qty, priceSnapshot:i.price })),
      amount: cart.reduce((s,i)=>s+i.price*i.qty,0),
      paymentMethod: pm,
      paymentStatus: "pending",
      shipmentStatus: "none",
      receiver: { name, phone },   // ← 不再存 address
      deliveryMethod,              // 'seven' | 'meetup'
      deliveryDetails,             // {storeName,storeId} 或 {place,time}
      createdAt: serverTimestamp(),
      paymentReport: {},
      notesFromBuyer: ""
    };

    const ref = await addDoc(collection(db, "orders"), order);
    // 同步到 Google 試算表（使用 Apps Script Web App）
// 若你的 Apps Script 有做 TOKEN 驗證，兩邊的字串要相同；沒做就把 token 這行拿掉
try {
  const payload = JSON.stringify({ token: 'LAL_SEC_1', id: ref.id, ...order });
  const ok = navigator.sendBeacon(
    'https://script.google.com/macros/s/AKfycbxdBl3QenD2h7eBqU38mP8yijCgY4HqYe-qU-xUUoDUdD0VcJcxOPDs58T_35Sv7w/exec',
    new Blob([payload], { type: 'application/json' })
  );
  if (!ok) {
    // 保底：若 sendBeacon 失敗就用非阻擋 fetch
    fetch('https://script.google.com/macros/s/AKfycbxdBl3QenD2h7eBqU38mP8yijCgY4HqYe-qU-xUUoDUdD0VcJcxOPDs58T_35Sv7w/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: payload
    }).catch(()=>{});
  }
} catch (_) { /* 忽略錯誤，不影響導頁 */ }

    localStorage.removeItem('cart');
    window.location.href = `order.html?id=${ref.id}`;
  });
</script>


</body>
</html>
