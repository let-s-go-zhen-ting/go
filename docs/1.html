<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>我的訂單</title>
  <link rel="stylesheet" href="assets/ui.css">
  <link rel="icon" type="image/png" href="favicon.png?v=2">
  <link rel="apple-touch-icon" href="apple-touch-icon.png?v=2">
  <style>
    .order-tabs{position:sticky;top:64px;z-index:15;background:#fff;border-bottom:1px solid #eee;padding:6px 0;margin:-6px 0 6px}
    .order-tabs .tab{border:1px solid #e5e7eb;background:#fff;padding:6px 10px;border-radius:9999px;margin-right:8px;cursor:pointer}
    .order-tabs .tab.active{background:#111;color:#fff;border-color:#111}
  </style>
</head>
<body>
  <!-- 置頂列：品牌 + 搜尋位留(無) + 購物車 + 頭貼 -->
  <header class="header-bar">
    <h1 style="margin:0;font-size:20px">我的訂單</h1>
    <div style="flex:1"></div>
    <a href="index.html" class="corner-brand" aria-label="首頁" style="text-decoration:none;color:inherit;display:flex;align-items:center;gap:8px;">
      <img src="favicon.png" alt="logo" style="width:28px;height:28px;border-radius:6px">
      <div>
        <div class="brand-zh" style="font-weight:700;line-height:1">啦此購</div>
        <div class="brand-en" style="font-size:12px;color:#6b7280;line-height:1">Let's Go！！！</div>
      </div>
    </a>
    <div class="cart-group">
      <a href="checkout.html" class="btn secondary">購物車/結帳</a>
      <span class="badge" id="cartCount">0</span>
    </div>
    <button id="avatarBtn" class="avatar" aria-label="開啟個人選單">我</button>
  </header>

  <!-- 右側抽屜 -->
  <div id="drawerMask"></div>
  <aside id="drawer"><div id="drawerProfile"></div></aside>

  <main>
    <!-- 分頁列（列表模式時顯示） -->
    <section class="order-tabs" id="tabs" style="display:none">
      <div class="row" style="gap:8px;flex-wrap:nowrap;overflow-x:auto">
        <button class="tab active" data-tab="all">全部</button>
        <button class="tab" data-tab="awaitPay">待付款</button>
        <button class="tab" data-tab="toShip">待發貨</button>
        <button class="tab" data-tab="inbound">待運回</button>
        <button class="tab" data-tab="toSend">待寄出</button>
        <button class="tab" data-tab="pickup">待取貨</button>
        <button class="tab" data-tab="meetup">待面交</button>
      </div>
    </section>

    <!-- 清單卡（列表模式時顯示） -->
    <section class="card" id="listCard" style="display:none">
      <h2>我的訂單</h2>
      <div id="list"></div>
    </section>

    <!-- 單筆訂單 -->
    <section class="card" id="singleCard">
      <div>訂單編號：<strong id="oid">...</strong></div>
      <div>金額：<strong id="amount">...</strong></div>
      <div>付款方式：<strong id="pm">...</strong></div>
      <div>付款狀態：<strong id="ps">...</strong></div>
      <div>進度：<strong id="stage">待付款</strong></div>
    </section>

    <section class="card" id="logCard">
      <h2>物流紀錄</h2>
      <div id="progressBox"></div>
    </section>

    <!-- 付款回報（LINE） -->
    <section class="card" id="lineReportBox" style="display:none">
      <h2>付款回報（LINE）</h2>
      <p class="small">請先按「複製回報內容」，再按「打開官方 LINE」貼上並傳送。</p>
      <div class="row">
        <button class="btn" id="copyLineMsg">複製回報內容</button>
        <a class="btn secondary" id="openLine" target="_blank" rel="noopener">打開官方 LINE</a>
      </div>
    </section>

    <!-- 管理員入口（僅白名單顯示） -->
    <section class="card" id="adminOnly" style="display:none">
      <h2>管理員工具</h2>
      <a class="btn" href="admin.html">開啟後台審單</a>
    </section>
  </main>

  <footer class="site-footer">
    <div class="row" style="justify-content:space-between">
      <div>
        <strong>客服資訊</strong><br>
        Email：<a href="mailto:letsgozhenting@gmail.com">letsgozhenting@gmail.com</a><br>
        LINE：<a href="https://lin.ee/305cGr5" target="_blank" rel="noopener">https://lin.ee/305cGr5</a><br>
        FB：<a href="https://www.facebook.com/share/17UF5BshaN/" target="_blank" rel="noopener">Facebook</a><br>
        IG：<a href="https://www.instagram.com/letsgo.zhen.ting?igsh=YmM3NTU2aHllMWl2" target="_blank" rel="noopener">@letsgo.zhen.ting</a>
      </div>
      <nav>
        <a href="privacy.html">隱私權條款</a> <span class="sep">｜</span>
        <a href="consumer-rights.html">消費者權益</a> <span class="sep">｜</span>
        <a href="tos.html">會員服務條款</a> <span class="sep">｜</span>
        <a href="returns.html">退換貨方式</a>
      </nav>
    </div>
    <div style="margin-top:8px;color:#9ca3af">© 2025 啦此購</div>
  </footer>

  <script type="module">
    import { db, auth, ensureSignedInAnon } from "./assets/firebase.js?v=8";
    import { collection, query, where, orderBy, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { setupDrawer } from "./assets/app.js?v=8";

    /* ===== 顯示/權限 ===== */
    const ADMINS = ["letsgozhenting@gmail.com"];
    onAuthStateChanged(auth, (u)=>{
      const isAdmin = !!u?.email && ADMINS.includes(u.email);
      document.getElementById('adminOnly').style.display = isAdmin ? 'block' : 'none';
    });

    const params  = new URLSearchParams(location.search);
    const orderId = params.get('id');
    const LINE_ID = '@935gvtgt';

    /* ===== 分頁清單邏輯 ===== */
    const tabsEl  = document.getElementById('tabs');
    const listCard= document.getElementById('listCard');
    let ORDERS = [];
    let currentTab = 'all';

    tabsEl.addEventListener('click', (e)=>{
      const b = e.target.closest('.tab'); if(!b) return;
      currentTab = b.dataset.tab;
      [...tabsEl.querySelectorAll('.tab')].forEach(x=>x.classList.toggle('active', x===b));
      renderList();
    });

    function inTab(o, tab){
      if(tab==='all') return true;
      if (o.progress && typeof o.progress[tab]==='boolean') return !!o.progress[tab];
      switch(tab){
        case 'awaitPay': return (o.paymentStatus||'')!=='paid';
        case 'toShip'  : return o.paymentStatus==='paid' && (!o.shipmentStatus || o.shipmentStatus==='none');
        case 'inbound' : return o.shipmentStatus==='inbound';
        case 'toSend'  : return o.shipmentStatus==='to_send';
        case 'pickup'  : return o.deliveryMethod==='seven' && ['arrived','pickup_ready'].includes(o.shipmentStatus||'');
        case 'meetup'  : return o.deliveryMethod==='meetup';
        default: return true;
      }
    }

    function renderList(){
      const list = document.getElementById('list');
      const rows = ORDERS.filter(o=>inTab(o.data, currentTab)).map(({id, data:o})=>{
        const created = o.createdAt?.toDate ? o.createdAt.toDate().toLocaleString('zh-TW') : '';
        return `
          <div class="row" style="justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding:8px 0">
            <div>
              <div><strong>${id}</strong></div>
              <div class="small">金額 NT$ ${o.amount||0}｜付款：${o.paymentMethod||'-'}｜狀態：${o.paymentStatus||'-'}
              ｜進度：${o.orderStatus||'-'}｜${created}</div>
            </div>
            <div><a class="btn secondary" href="order.html?id=${encodeURIComponent(id)}">查看</a></div>
          </div>`;
      });
      list.innerHTML = rows.length ? rows.join('') : `<div class="small">這個分類目前沒有訂單</div>`;
    }

    async function loadList(){
      const uid = auth.currentUser.uid;
      let snaps;
      try{
        snaps = await getDocs(query(collection(db,"orders"), where("uid","==", uid), orderBy("createdAt","desc")));
      }catch{
        snaps = await getDocs(query(collection(db,"orders"), where("uid","==", uid)));
      }
      ORDERS = [];
      snaps.forEach(s=>ORDERS.push({id:s.id, data:s.data()}));

      tabsEl.style.display = 'block';
      listCard.style.display = 'block';
      document.getElementById('singleCard').style.display = 'none';
      document.getElementById('lineReportBox').style.display = 'none';

      renderList();
    }

    /* ===== 單筆訂單 ===== */
    async function loadSingle(id){
      const snap = await getDoc(doc(db,"orders",id));
      if(!snap.exists()){ alert('找不到訂單'); return; }
      const o = snap.data();

      document.getElementById('oid').textContent    = id;
      document.getElementById('amount').textContent = 'NT$ ' + o.amount;
      document.getElementById('pm').textContent     = o.paymentMethod;
      document.getElementById('ps').textContent     = o.paymentStatus;
      document.getElementById('stage').textContent  = o.orderStatus || '待付款';

      const box = document.getElementById('lineReportBox');
      if (o.paymentMethod !== 'cod') {
        const msg = [
          '【付款回報】',
          `訂單編號：${id}`,
          `金額：NT$ ${o.amount}`,
          `付款方式：${o.paymentMethod==='bank_transfer'?'匯款':'無卡存款'}`,
          '匯款後五碼：_____（或存款日期/時間）',
          '備註：'
        ].join('\n');
        box.style.display = 'block';
        document.getElementById('copyLineMsg').onclick = async ()=>{
          try{ await navigator.clipboard.writeText(msg); alert('已複製，請貼到 LINE 傳給我們'); }
          catch{ alert('複製失敗，請手動複製'); }
        };
        document.getElementById('openLine').href = `https://line.me/R/ti/p/${encodeURIComponent(LINE_ID)}`;
      } else {
        box.style.display = 'none';
      }
    }

    /* ===== 入口 ===== */
    await ensureSignedInAnon();
    const countEl = document.getElementById('cartCount');
    const cart = JSON.parse(localStorage.getItem('cart')||'[]');
    if(countEl) countEl.textContent = cart.reduce((s,i)=>s+i.qty,0);
    setupDrawer();

    if (orderId) {
      await loadSingle(orderId);
    } else {
      await loadList();
    }
  </script>
</body>
</html>
```0
