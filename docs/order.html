<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>我的訂單</title>
  <link rel="stylesheet" href="assets/ui.css">
</head>
<body>
  <header>
    <h1>訂單狀態</h1>
    <div><a class="btn secondary" href="index.html">回商店</a></div>
  </header>

  <section class="card">
    <div>訂單編號：<strong id="oid">...</strong></div>
    <div>金額：<strong id="amount">...</strong></div>
    <div>付款方式：<strong id="pm">...</strong></div>
    <div>付款狀態：<strong id="ps">...</strong></div>
  </section>

  <section class="card" id="lineReportBox" style="display:none">
    <h2>付款回報（LINE）</h2>
    <p class="small">請先按「複製回報內容」，再按「打開官方 LINE」貼上並傳送。</p>
    <div class="row">
      <button class="btn" id="copyLineMsg">複製回報內容</button>
      <a class="btn secondary" id="openLine" target="_blank">打開官方 LINE</a>
    </div>
  </section>

<script type="module">
  import { db, auth, ensureSignedInAnon } from "./assets/firebase.js?v=8";
  import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const LINE_ID = '@你的官方LineID'; // 例：@abcd1234
  function getParam(n){ return new URLSearchParams(location.search).get(n); }
  const orderId = getParam('id');
  document.getElementById('oid').textContent = orderId || '';

  async function load(){
    await ensureSignedInAnon();
    const snap = await getDoc(doc(db, "orders", orderId));
    if(!snap.exists()){ alert('找不到訂單'); return; }
    const o = snap.data();

    document.getElementById('amount').textContent = 'NT$ '+o.amount;
    document.getElementById('pm').textContent = o.paymentMethod;
    document.getElementById('ps').textContent = o.paymentStatus;

    if(o.paymentMethod !== 'cod'){
      const msg = [
        '【付款回報】',
        `訂單編號：${orderId}`,
        `金額：NT$ ${o.amount}`,
        `付款方式：${o.paymentMethod==='bank_transfer'?'匯款':'無卡存款'}`,
        '匯款後五碼：_____（或存款日期/時間）',
        '備註：'
      ].join('\n');
      const box = document.getElementById('lineReportBox');
      box.style.display = 'block';
      document.getElementById('copyLineMsg').onclick = async ()=>{
        try{ await navigator.clipboard.writeText(msg); alert('已複製，請貼到 LINE 傳給我們'); }
        catch{ alert('複製失敗，請手動複製'); }
      };
      document.getElementById('openLine').href = `https://line.me/R/ti/p/${encodeURIComponent(LINE_ID)}`;
    }
  }
  load();
</script>
</body>
</html>
