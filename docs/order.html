<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>我的訂單</title>
  <link rel="stylesheet" href="assets/ui.css">
  <!-- Favicon / PWA icons -->
<link rel="icon" type="image/png" href="favicon.png?v=2">
<link rel="apple-touch-icon" href="apple-touch-icon.png?v=2">

</head>
<body>
  <header class="header-bar">
  <!-- 中間只有標題；留一個彈性空間把右側頂住 -->
  <h1 style="margin:0;font-size:20px">我的訂單</h1>
  <div style="flex:1"></div>

  <!-- 右側：品牌 + 購物車 + 頭貼 -->
  <div class="cart-group">
    <a href="index.html" class="corner-brand" aria-label="首頁" style="text-decoration:none;color:inherit;display:flex;align-items:center;gap:8px;">
      <img src="favicon.png" alt="logo" style="width:28px;height:28px;border-radius:6px">
      <div>
        <div class="brand-zh" style="font-weight:700;line-height:1">啦此購</div>
        <div class="brand-en" style="font-size:12px;color:#6b7280;line-height:1">Let's Go！！！</div>
      </div>
    </a>

    <a href="checkout.html" class="btn secondary">購物車/結帳</a>
    <span class="badge" id="cartCount">0</span>
  </div>
  <button id="avatarBtn" class="avatar" aria-label="開啟個人選單">我</button>
</header>

<!-- 右側抽屜（和首頁一致，放在 body 最後也可以）-->
<div id="drawerMask"></div>
<aside id="drawer">
  <div id="drawerProfile"></div>
</aside>


  <main>
  <!-- 單筆訂單：基本資訊 -->
  <section class="card" id="singleCard">
    <div>訂單編號：<strong id="oid">...</strong></div>
    <div>金額：<strong id="amount">...</strong></div>
    <div>付款方式：<strong id="pm">...</strong></div>
    <div>付款狀態：<strong id="ps">...</strong></div>
    <div>進度：<strong id="stage">待付款</strong></div>  <!-- 新增 -->
  </section>

  <!-- 新增：物流紀錄 -->
  <section class="card">
    <h2>物流紀錄</h2>
    <div id="progressBox"></div>
  </section>
  
  <!-- 單筆訂單：付款回報（LINE） -->
  <section class="card" id="lineReportBox" style="display:none">
    <h2>付款回報（LINE）</h2>
    <p class="small">請先按「複製回報內容」，再按「打開官方 LINE」貼上並傳送。</p>
    <div class="row">
      <button class="btn" id="copyLineMsg">複製回報內容</button>
      <a class="btn secondary" id="openLine" target="_blank">打開官方 LINE</a>
    </div>
  </section>
  
  <section class="card" id="adminOnly" style="display:none">
  <h2>管理員工具</h2>
  <a class="btn" href="admin.html">開啟後台審單</a>
</section>

  <script type="module">
  import { db, auth, ensureSignedInAnon } from "./assets/firebase.js?v=8";
  import {
    doc, getDoc,
    collection, query, where, orderBy, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { setupDrawer } from "./assets/app.js?v=8";
    
  const ADMINS = ["letsgozhenting@gmail.com"];
  onAuthStateChanged(auth, (u)=>{
    const isAdmin = !!u?.email && ADMINS.includes(u.email);
    document.getElementById('adminOnly').style.display = isAdmin ? 'block' : 'none';
  });

  const params  = new URLSearchParams(location.search);
  const orderId = params.get('id');
  const $ = (s)=>document.querySelector(s);

  const LINE_ID = '@935gvtgt';
  const singleCard = $('#singleCard');

  // 建「我的訂單」列表卡（沒有帶 id 才顯示）
  const listWrap = document.createElement('section');
  listWrap.className = 'card';
  listWrap.innerHTML = `<h2>我的訂單</h2><div id="list"></div>`;
  if (!orderId) {
    // ✅ 這裡改用 singleCard 的父層（<main>）插入，避免 NotFoundError
    singleCard.parentElement.insertBefore(listWrap, singleCard);
  }

  const fmtTime = (ts)=>{
    if(!ts?.toDate) return '';
    const d = ts.toDate();
    return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  };

  async function loadSingle(id){
    const snap = await getDoc(doc(db, "orders", id));
    if(!snap.exists()){ alert('找不到訂單'); return; }
    const o = snap.data();

    $('#oid').textContent    = id;
    $('#amount').textContent = 'NT$ ' + o.amount;
    $('#pm').textContent     = o.paymentMethod;
    $('#ps').textContent     = o.paymentStatus;
    $('#stage').textContent  = o.orderStatus || '待付款';

    const box = document.getElementById('lineReportBox');
    if (o.paymentMethod !== 'cod') {
      const msg = [
        '【付款回報】',
        `訂單編號：${id}`,
        `金額：NT$ ${o.amount}`,
        `付款方式：${o.paymentMethod==='bank_transfer'?'匯款':'無卡存款'}`,
        '匯款後五碼：_____（或存款日期/時間）',
        '備註：'
      ].join('\n');
      box.style.display = 'block';
      document.getElementById('copyLineMsg').onclick = async ()=>{
        try{ await navigator.clipboard.writeText(msg); alert('已複製，請貼到 LINE 傳給我們'); }
        catch{ alert('複製失敗，請手動複製'); }
      };
      document.getElementById('openLine').href = `https://line.me/R/ti/p/${encodeURIComponent(LINE_ID)}`;
    } else {
      box.style.display = 'none';
    }
  }

  async function loadList(){
    const uid = auth.currentUser.uid;
    console.log('Current UID:', uid);

    const base = collection(db, "orders");
    let snaps;
    try {
      snaps = await getDocs(query(base, where("uid","==", uid), orderBy("createdAt","desc")));
    } catch (e) {
      console.warn('沒有索引或查詢失敗，改用無排序查詢。', e);
      snaps = await getDocs(query(base, where("uid","==", uid)));
    }

    const list = document.getElementById('list');
    const out = [];
    snaps.forEach(s=>{
      const o = s.data();
      out.push(`
        <div class="row" style="justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding:8px 0">
          <div>
            <div><strong>${s.id}</strong></div>
            <div class="small">
              金額 NT$ ${o.amount||0}｜付款：${o.paymentMethod||'-'}
              ｜狀態：${o.paymentStatus||'-'}
              ｜進度：${o.orderStatus||'待付款'}
              ｜${o.createdAt?.toDate ? (o.createdAt.toDate().toLocaleString('zh-TW')) : ''}
            </div>
          </div>
          <div>
            <a class="btn secondary" href="order.html?id=${encodeURIComponent(s.id)}">查看</a>
          </div>
        </div>
      `);
    });

    list.innerHTML = out.length ? out.join('') :
      `<div class="small">目前沒有訂單（目前 UID：${uid.slice(0,8)}…）</div>`;

    if(!orderId){
      document.getElementById('singleCard').style.display = 'none';
      document.getElementById('lineReportBox').style.display = 'none';
    }
  }

  // 入口
  await ensureSignedInAnon();
  if(orderId){
    $('#oid').textContent = orderId;
    await loadSingle(orderId);
  }else{
    await loadList();
  }
    
  const cart = JSON.parse(localStorage.getItem('cart')||'[]');
  const el = document.getElementById('cartCount'); if(el) el.textContent = cart.reduce((s,i)=>s+i.qty,0);
  setupDrawer();
</script>

  </main>

  <footer class="site-footer">
  <div class="row" style="justify-content:space-between">
    <div>
      <strong>客服資訊</strong><br>
      Email：<a href="mailto:letsgozhenting@gmail.com">letsgozhenting@gmail.com</a><br>
      LINE：<a href="https://lin.ee/305cGr5" target="_blank" rel="noopener">https://lin.ee/305cGr5</a><br>
      FB：<a href="https://www.facebook.com/share/17UF5BshaN/" target="_blank" rel="noopener">Facebook</a><br>
      IG：<a href="https://www.instagram.com/letsgo.zhen.ting?igsh=YmM3NTU2aHllMWl2" target="_blank" rel="noopener">@letsgo.zhen.ting</a>
    </div>
    <nav>
      <a href="privacy.html">隱私權條款</a> <span class="sep">｜</span>
      <a href="consumer-rights.html">消費者權益</a> <span class="sep">｜</span>
      <a href="tos.html">會員服務條款</a> <span class="sep">｜</span>
      <a href="returns.html">退換貨方式</a>
    </nav>
  </div>
  <div style="margin-top:8px;color:#9ca3af">© 2025 啦此購</div>
</footer>

</body>
</html>
